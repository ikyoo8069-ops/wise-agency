<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1B9DCYC3RXJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-1B9DCYC3RXJ');
    </script>
    
    <title>ìŠ¬ê¸°ë¡œìš´ ì§„í¥ì›ìƒí™œ v2.0</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f9f9f9;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #fff;
            border-bottom: 1px solid #e5e5e5;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .header .badge {
            font-size: 11px;
            background: #f0f0f0;
            color: #666;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .header .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ccc;
            display: inline-block;
        }

        .header .status-dot.connected { background: #28a745; }
        .header .status-dot.error { background: #dc3545; }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .chat-content {
            max-width: 800px;
            margin: 0 auto;
        }

        .message {
            margin-bottom: 24px;
        }

        .message.user {
            background: #f7f7f7;
            border-radius: 12px;
            padding: 16px 20px;
        }

        .message.user .content {
            color: #1a1a1a;
            font-size: 15px;
            line-height: 1.6;
        }

        .message.assistant {
            padding: 16px 0;
        }

        .message.assistant .content {
            color: #1a1a1a;
            font-size: 15px;
            line-height: 1.7;
            white-space: pre-wrap;
        }

        .n2b-box {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
        }

        .n2b-title {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .n2b-item {
            margin-bottom: 14px;
        }

        .n2b-item:last-child {
            margin-bottom: 0;
        }

        .n2b-label {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .n2b-label.not { color: #dc3545; }
        .n2b-label.but { color: #28a745; }
        .n2b-label.because { color: #007bff; }

        .n2b-content {
            font-size: 14px;
            color: #333;
            line-height: 1.5;
            padding-left: 12px;
            border-left: 3px solid #e5e5e5;
        }

        .suggestion-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .suggestion-title {
            font-size: 13px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }

        .suggestion-content {
            font-size: 14px;
            color: #333;
            line-height: 1.5;
        }

        .next-action {
            margin-top: 12px;
            padding: 10px 14px;
            background: #1a1a1a;
            border-radius: 8px;
            font-size: 14px;
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 16px;
            border: 1px solid #e5e5e5;
            background: #fff;
            border-radius: 20px;
            font-size: 13px;
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        .action-btn.primary {
            background: #1a1a1a;
            color: white;
            border-color: #1a1a1a;
        }

        .action-btn.primary:hover {
            background: #333;
        }

        .input-area {
            background: #fff;
            border-top: 1px solid #e5e5e5;
            padding: 16px 20px;
        }

        .input-wrapper {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: #f7f7f7;
            border-radius: 24px;
            padding: 8px 8px 8px 20px;
        }

        .input-field {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 15px;
            padding: 8px 0;
            outline: none;
            resize: none;
            font-family: inherit;
            min-height: 24px;
            max-height: 200px;
        }

        .input-field::placeholder {
            color: #999;
        }

        .send-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: #1a1a1a;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: background 0.2s;
        }

        .send-btn:hover {
            background: #333;
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .sample-buttons {
            max-width: 800px;
            margin: 0 auto 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .sample-btn {
            padding: 8px 16px;
            border: 1px solid #e5e5e5;
            background: #fff;
            border-radius: 20px;
            font-size: 13px;
            color: #555;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sample-btn:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        .typing {
            display: flex;
            gap: 4px;
            padding: 20px 0;
        }

        .typing span {
            width: 8px;
            height: 8px;
            background: #ccc;
            border-radius: 50%;
            animation: typing 1s infinite;
        }

        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .footer-info {
            text-align: center;
            font-size: 12px;
            color: #999;
            padding: 8px;
        }

        @media (max-width: 600px) {
            .chat-content, .input-wrapper, .sample-buttons {
                max-width: 100%;
            }
            
            .input-wrapper {
                border-radius: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ›ï¸ ìŠ¬ê¸°ë¡œìš´ ì§„í¥ì›ìƒí™œ</h1>
        <span class="badge">N2B v2.0</span>
        <span class="status-dot" id="statusDot" title="ë°±ì—”ë“œ ì—°ê²° í™•ì¸ ì¤‘..."></span>
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="chat-content" id="chatContent">
        </div>
    </div>

    <div class="input-area">
        <div class="sample-buttons" id="sampleButtons">
            <button class="sample-btn" onclick="sendSample('ê¸°ì—…ì§€ì› ì‚¬ì—…ì´ ì–´ë ¤ì›Œìš”')">ê¸°ì—…ì§€ì›</button>
            <button class="sample-btn" onclick="sendSample('ì„±ê³¼í‰ê°€ê°€ ê±±ì •ë¼ìš”')">ì„±ê³¼í‰ê°€</button>
            <button class="sample-btn" onclick="sendSample('ì‚¬ì—…ê¸°íšì„ ë„ì™€ì£¼ì„¸ìš”')">ì‚¬ì—…ê¸°íš</button>
            <button class="sample-btn" onclick="sendSample('ë³´ê³ ì„œ ì‘ì„±ì´ ì–´ë ¤ì›Œìš”')">ë³´ê³ ì„œ</button>
            <button class="sample-btn" onclick="sendSample('í˜‘ë ¥ê¸°ê´€ê³¼ ê°ˆë“±ì´ ìˆì–´ìš”')">í˜‘ë ¥ê¸°ê´€</button>
            <button class="sample-btn" onclick="sendSample('íŒ€ì›Œí¬ê°€ ì•ˆ ë§ì•„ìš”')">íŒ€ì›Œí¬</button>
        </div>
        <div class="input-wrapper">
            <input type="text" class="input-field" id="userInput" placeholder="ì§„í¥ì› ì—…ë¬´ ê³ ë¯¼ì„ ë§ì”€í•´ì£¼ì„¸ìš”..." onkeypress="handleKeyPress(event)">
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">â†‘</button>
        </div>
        <div class="footer-info">N2B í”„ë ˆì„ì›Œí¬ë¡œ ì—…ë¬´ ê³ ë¯¼ì„ ë¶„ì„í•©ë‹ˆë‹¤ Â· ë°±ì—”ë“œ ë³´ì•ˆ ì—°ë™</div>
    </div>

    <script>
        // âœ… v2.0 - ë°±ì—”ë“œ ì—°ë™ (API í‚¤ ì œê±°)
        const BACKEND_URL = 'https://n2b-backend-1.onrender.com';
        
        const chatContent = document.getElementById('chatContent');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const sampleButtons = document.getElementById('sampleButtons');
        const statusDot = document.getElementById('statusDot');

        let messages = [];
        let isLoading = false;
        let currentDepth = 0;
        let lastN2BAnalysis = null;

        // âœ… ë°±ì—”ë“œ í—¬ìŠ¤ì²´í¬
        async function checkBackendHealth() {
            try {
                const resp = await fetch(`${BACKEND_URL}/health`, { signal: AbortSignal.timeout(10000) });
                if (resp.ok) {
                    statusDot.className = 'status-dot connected';
                    statusDot.title = 'ë°±ì—”ë“œ ì—°ê²°ë¨';
                    return true;
                }
            } catch (e) {}
            statusDot.className = 'status-dot error';
            statusDot.title = 'ë°±ì—”ë“œ ì—°ê²° ì‹¤íŒ¨ - ì ì‹œ í›„ ì¬ì‹œë„';
            return false;
        }

        function init() {
            checkBackendHealth();
            addAssistantMessage(`ì•ˆë…•í•˜ì„¸ìš”! ğŸ˜Š

ì§„í¥ì› ì—…ë¬´ê³ ë¯¼ì„ N2Bë¡œ ì •ë¦¬í•´ë“œë ¤ìš”. ë¬´ì—‡ì´ë“  ë§ì”€í•´ ë³´ì„¸ìš”!

ğŸ’¡ N2Bë€? (ê°€ì„¤ê²€ì •ì˜ ë…¼ë¦¬êµ¬ì¡°)
NOT(ì•„ë‹ˆë‹¤) - BUT(ì§„ì§œëŠ”) - BECAUSE(ì™œëƒí•˜ë©´)
í‘œë©´ì  ì›ì¸ì„ ë¶€ì •í•˜ê³ , ì§„ì§œ ì›ì¸ì„ ì°¾ì•„, ê·¼ê±°ë¥¼ ì œì‹œí•©ë‹ˆë‹¤.

[ê¸°ì—…ì§€ì›/ì‚¬ì—…]
ğŸ“‹ ê¸°ì—…ì§€ì› ì‚¬ì—…ì´ ì–´ë ¤ì›Œìš” | ğŸ“Š ì„±ê³¼í‰ê°€ê°€ ê±±ì •ë¼ìš”
ğŸ¯ ì‚¬ì—…ê¸°íšì„ ë„ì™€ì£¼ì„¸ìš” | ğŸ“ ë³´ê³ ì„œ ì‘ì„±ì´ ì–´ë ¤ì›Œìš”
ğŸ¤ í˜‘ë ¥ê¸°ê´€ê³¼ ê°ˆë“±ì´ ìˆì–´ìš” | ğŸ’° ì˜ˆì‚° ì§‘í–‰ì´ ì–´ë ¤ì›Œìš”
ğŸ“… ì‚¬ì—… ì¼ì •ì´ ì´‰ë°•í•´ìš” | ğŸ¢ ê¸°ì—… ë°œêµ´ì´ ì•ˆ ë¼ìš”
ğŸ“ˆ KPI ë‹¬ì„±ì´ ì–´ë ¤ì›Œìš” | ğŸ”„ í›„ì† ì‚¬ì—… ì—°ê³„

[ê°œì¸/ìƒí™œ]
ğŸ¯ ì„±ê³¼ê°€ ì•ˆ ë‚˜ì™€ìš” | ğŸ“ˆ ìŠ¹ì§„ì´ ì•ˆ ë©ë‹ˆë‹¤
ğŸ˜© ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ì‹¬í•´ìš” | ğŸ‘¥ ëŒ€ì¸ê´€ê³„ ì–´ë ¤ì›€
ğŸ‘” íŒ€ì›Œí¬ê°€ ì•ˆ ë§ì•„ìš” | ğŸ˜” ì—…ë¬´ ì˜ë¯¸ ê³ ë¯¼
ğŸ“… íšŒì˜ê°€ ë„ˆë¬´ ë§ì•„ìš” | âš–ï¸ ì›Œë¼ë°¸ì´ ì•ˆ ë§ì•„ìš”

ğŸ‘† ìœ„ëŠ” ì§ˆë¬¸ì‚¬ë¡€ì™€ ë‹µë³€ë°©í–¥ì…ë‹ˆë‹¤.
ğŸ‘‡ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ë°”ë¡œ ì²´í—˜í•  ìˆ˜ ìˆì–´ìš”!`);
        }

        function addUserMessage(text) {
            const div = document.createElement('div');
            div.className = 'message user';
            div.innerHTML = `<div class="content">${escapeHtml(text)}</div>`;
            chatContent.appendChild(div);
            scrollToBottom();
        }

        function addAssistantMessage(text) {
            const div = document.createElement('div');
            div.className = 'message assistant';
            div.innerHTML = `<div class="content">${escapeHtml(text)}</div>`;
            chatContent.appendChild(div);
            scrollToBottom();
        }

        function addN2BResponse(response, depth) {
            const responseId = 'response_' + Date.now();
            window[responseId] = response;

            const div = document.createElement('div');
            div.className = 'message assistant';
            div.innerHTML = `
                <div class="n2b-box">
                    <div class="n2b-title">ğŸ” N2B ë¶„ì„</div>
                    <div class="n2b-item">
                        <div class="n2b-label not">âŒ NOT (ì•„ë‹ˆë‹¤)</div>
                        <div class="n2b-content">${escapeHtml(response.n2b.not)}</div>
                    </div>
                    <div class="n2b-item">
                        <div class="n2b-label but">âœ“ BUT (ì§„ì§œëŠ”)</div>
                        <div class="n2b-content">${escapeHtml(response.n2b.but)}</div>
                    </div>
                    <div class="n2b-item">
                        <div class="n2b-label because">ğŸ’¡ BECAUSE (ì™œëƒí•˜ë©´)</div>
                        <div class="n2b-content">${escapeHtml(response.n2b.because)}</div>
                    </div>
                </div>
                <div class="suggestion-box">
                    <div class="suggestion-title">ğŸ¯ ì´ë ‡ê²Œ í•´ë³´ì„¸ìš”</div>
                    <div class="suggestion-content">${escapeHtml(response.suggestion)}</div>
                    ${response.nextAction ? `<div class="next-action">ğŸ‘‰ ${escapeHtml(response.nextAction)}</div>` : ''}
                </div>
                <div class="action-buttons">
                    <button class="action-btn primary" onclick="deepDive()">ğŸŒŠ ë” ê¹Šì´ ë¶„ì„</button>
                    <button class="action-btn" onclick="downloadResult('${responseId}')">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>
                    <button class="action-btn" onclick="startNewTopic()">ğŸ’¬ ìƒˆ ê³ ë¯¼</button>
                </div>
            `;
            chatContent.appendChild(div);
            scrollToBottom();
        }

        function showTyping() {
            const div = document.createElement('div');
            div.className = 'message assistant';
            div.id = 'typingIndicator';
            div.innerHTML = `<div class="typing"><span></span><span></span><span></span></div>`;
            chatContent.appendChild(div);
            scrollToBottom();
        }

        function hideTyping() {
            const el = document.getElementById('typingIndicator');
            if (el) el.remove();
        }

        function scrollToBottom() {
            const container = document.getElementById('chatContainer');
            container.scrollTop = container.scrollHeight;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        // âœ… N2B ë¶„ì„ - ë°±ì—”ë“œ í˜¸ì¶œ
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text || isLoading) return;

            sampleButtons.style.display = 'none';

            addUserMessage(text);
            userInput.value = '';

            if (currentDepth === 0) {
                currentDepth = 1;
            }

            isLoading = true;
            sendBtn.disabled = true;
            showTyping();

            try {
                const resp = await fetch(`${BACKEND_URL}/api/agency-analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ worry: text })
                });

                if (!resp.ok) {
                    const errData = await resp.json().catch(() => ({}));
                    throw new Error(errData.detail || `ì„œë²„ ì˜¤ë¥˜ (${resp.status})`);
                }

                const data = await resp.json();
                hideTyping();

                if (data.success && data.result) {
                    lastN2BAnalysis = data.result;
                    // ëŒ€í™” íˆìŠ¤í† ë¦¬ ì €ì¥ (ê¹Šì´ë¶„ì„ìš©)
                    messages = [
                        { role: 'user', content: text },
                        { role: 'assistant', content: JSON.stringify(data.result) }
                    ];
                    addN2BResponse(data.result, currentDepth);
                } else {
                    addAssistantMessage("ë¶„ì„ ê²°ê³¼ë¥¼ íŒŒì‹±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                }
            } catch (error) {
                hideTyping();
                addAssistantMessage(`ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n${error.message}\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`);
                checkBackendHealth();
            }

            isLoading = false;
            sendBtn.disabled = false;
            userInput.focus();
        }

        // âœ… ê¹Šì´ë¶„ì„ - ë°±ì—”ë“œ í˜¸ì¶œ
        async function deepDive() {
            if (isLoading || !lastN2BAnalysis) return;

            currentDepth++;
            isLoading = true;
            sendBtn.disabled = true;
            showTyping();

            try {
                const resp = await fetch(`${BACKEND_URL}/api/agency-deepdive`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        previous_but: lastN2BAnalysis.n2b.but,
                        messages: messages
                    })
                });

                if (!resp.ok) {
                    const errData = await resp.json().catch(() => ({}));
                    throw new Error(errData.detail || `ì„œë²„ ì˜¤ë¥˜ (${resp.status})`);
                }

                const data = await resp.json();
                hideTyping();

                if (data.success && data.result) {
                    lastN2BAnalysis = data.result;
                    // ëŒ€í™” íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
                    messages.push(
                        { role: 'user', content: `ì´ì „ ë¶„ì„ì˜ "${lastN2BAnalysis.n2b.but}"ë¥¼ ë” ê¹Šì´ ë¶„ì„` },
                        { role: 'assistant', content: JSON.stringify(data.result) }
                    );
                    addN2BResponse(data.result, currentDepth);
                } else {
                    addAssistantMessage("ê¹Šì´ë¶„ì„ ê²°ê³¼ë¥¼ íŒŒì‹±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                }
            } catch (error) {
                hideTyping();
                addAssistantMessage(`ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n${error.message}`);
                checkBackendHealth();
            }

            isLoading = false;
            sendBtn.disabled = false;
        }

        function sendSample(text) {
            userInput.value = text;
            sendMessage();
        }

        function startNewTopic() {
            currentDepth = 0;
            lastN2BAnalysis = null;
            messages = [];
            sampleButtons.style.display = 'flex';
            addAssistantMessage("ìƒˆë¡œìš´ ê³ ë¯¼ì´ ìˆìœ¼ì‹œë©´ ë§ì”€í•´ì£¼ì„¸ìš”! ğŸ˜Š");
            userInput.focus();
        }

        function downloadResult(responseId) {
            const response = window[responseId];
            if (!response) return;

            const now = new Date();
            const dateStr = now.toLocaleDateString('ko-KR');
            const timeStr = now.toLocaleTimeString('ko-KR');

            let content = `[ìŠ¬ê¸°ë¡œìš´ ì§„í¥ì›ìƒí™œ - N2B ë¶„ì„ ê²°ê³¼]\n`;
            content += `ìƒì„±ì¼ì‹œ: ${dateStr} ${timeStr}\n`;
            content += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
            content += `[N2B ë¶„ì„]\n`;
            content += `âŒ NOT (ì•„ë‹ˆë‹¤):\n${response.n2b.not}\n\n`;
            content += `âœ“ BUT (ì§„ì§œëŠ”):\n${response.n2b.but}\n\n`;
            content += `ğŸ’¡ BECAUSE (ì™œëƒí•˜ë©´):\n${response.n2b.because}\n\n`;
            content += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
            content += `[ì œì•ˆ]\n${response.suggestion}\n`;
            if (response.nextAction) {
                content += `\n[ë‹¤ìŒ í–‰ë™]\n${response.nextAction}\n`;
            }

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `N2Bë¶„ì„_${dateStr.replace(/\./g, '')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter' && !isLoading) {
                sendMessage();
            }
        }

        init();
    </script>
</body>
</html>
