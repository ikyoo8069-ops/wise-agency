<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¬ê¸°ë¡œìš´ ì§„í¥ì›ìƒí™œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f9f9f9;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* í—¤ë” */
        .header {
            background: #fff;
            border-bottom: 1px solid #e5e5e5;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .header .badge {
            font-size: 11px;
            background: #f0f0f0;
            color: #666;
            padding: 4px 8px;
            border-radius: 4px;
        }

        /* ì±„íŒ… ì˜ì—­ */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .chat-content {
            max-width: 800px;
            margin: 0 auto;
        }

        /* ë©”ì‹œì§€ */
        .message {
            margin-bottom: 24px;
        }

        .message.user {
            background: #f7f7f7;
            border-radius: 12px;
            padding: 16px 20px;
        }

        .message.user .content {
            color: #1a1a1a;
            font-size: 15px;
            line-height: 1.6;
        }

        .message.assistant {
            padding: 16px 0;
        }

        .message.assistant .content {
            color: #1a1a1a;
            font-size: 15px;
            line-height: 1.7;
            white-space: pre-wrap;
        }

        /* N2B ë¶„ì„ ë°•ìŠ¤ */
        .n2b-box {
            background: #fff;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
        }

        .n2b-title {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .n2b-item {
            margin-bottom: 14px;
        }

        .n2b-item:last-child {
            margin-bottom: 0;
        }

        .n2b-label {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .n2b-label.not { color: #dc3545; }
        .n2b-label.but { color: #28a745; }
        .n2b-label.because { color: #007bff; }

        .n2b-content {
            font-size: 14px;
            color: #333;
            line-height: 1.5;
            padding-left: 12px;
            border-left: 3px solid #e5e5e5;
        }

        /* ì œì•ˆ ë°•ìŠ¤ */
        .suggestion-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .suggestion-title {
            font-size: 13px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }

        .suggestion-content {
            font-size: 14px;
            color: #333;
            line-height: 1.5;
        }

        .next-action {
            margin-top: 12px;
            padding: 10px 14px;
            background: #1a1a1a;
            border-radius: 8px;
            font-size: 14px;
            color: white;
        }

        /* ë²„íŠ¼ë“¤ */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 16px;
            border: 1px solid #e5e5e5;
            background: #fff;
            border-radius: 20px;
            font-size: 13px;
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        .action-btn.primary {
            background: #1a1a1a;
            color: white;
            border-color: #1a1a1a;
        }

        .action-btn.primary:hover {
            background: #333;
        }

        /* ì…ë ¥ ì˜ì—­ */
        .input-area {
            background: #fff;
            border-top: 1px solid #e5e5e5;
            padding: 16px 20px;
        }

        .input-wrapper {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: #f7f7f7;
            border-radius: 24px;
            padding: 8px 8px 8px 20px;
        }

        .input-field {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 15px;
            padding: 8px 0;
            outline: none;
            resize: none;
            font-family: inherit;
            min-height: 24px;
            max-height: 200px;
        }

        .input-field::placeholder {
            color: #999;
        }

        .attach-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .attach-btn:hover {
            background: #e5e5e5;
        }

        .send-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: #1a1a1a;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: background 0.2s;
        }

        .send-btn:hover {
            background: #333;
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* ìƒ˜í”Œ ë²„íŠ¼ */
        .sample-buttons {
            max-width: 800px;
            margin: 0 auto 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
        }

        .sample-btn {
            padding: 8px 16px;
            border: 1px solid #e5e5e5;
            background: #fff;
            border-radius: 20px;
            font-size: 13px;
            color: #555;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sample-btn:hover {
            background: #f5f5f5;
            border-color: #ccc;
        }

        /* íŒŒì¼ ì²¨ë¶€ */
        .file-input {
            display: none;
        }

        .attached-file {
            max-width: 800px;
            margin: 0 auto 10px;
            padding: 8px 12px;
            background: #e8f4e8;
            border-radius: 8px;
            font-size: 13px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .attached-file .remove {
            cursor: pointer;
            color: #666;
        }

        /* íƒ€ì´í•‘ ì¸ë””ì¼€ì´í„° */
        .typing {
            display: flex;
            gap: 4px;
            padding: 20px 0;
        }

        .typing span {
            width: 8px;
            height: 8px;
            background: #ccc;
            border-radius: 50%;
            animation: typing 1s infinite;
        }

        .typing span:nth-child(2) { animation-delay: 0.2s; }
        .typing span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ */
        .download-btn {
            margin-top: 12px;
            padding: 8px 16px;
            border: 1px solid #e5e5e5;
            background: #fff;
            border-radius: 8px;
            font-size: 13px;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }

        .download-btn:hover {
            background: #f5f5f5;
        }

        /* í•˜ë‹¨ ì •ë³´ */
        .footer-info {
            text-align: center;
            font-size: 12px;
            color: #999;
            padding: 8px;
        }

        /* ëª¨ë°”ì¼ */
        @media (max-width: 600px) {
            .chat-content, .input-wrapper, .sample-buttons {
                max-width: 100%;
            }
            
            .input-wrapper {
                border-radius: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ›ï¸ ìŠ¬ê¸°ë¡œìš´ ì§„í¥ì›ìƒí™œ</h1>
        <span class="badge">N2B</span>
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="chat-content" id="chatContent">
            <!-- ë©”ì‹œì§€ë“¤ -->
        </div>
    </div>

    <div class="input-area">
        <div id="attachedFileArea"></div>
        <div class="sample-buttons" id="sampleButtons">
            <button class="sample-btn" onclick="sendSample('ê¸°ì—…ì§€ì› ì‚¬ì—…ì´ ì–´ë ¤ì›Œìš”')">ê¸°ì—…ì§€ì›</button>
            <button class="sample-btn" onclick="sendSample('ì„±ê³¼í‰ê°€ê°€ ê±±ì •ë¼ìš”')">ì„±ê³¼í‰ê°€</button>
            <button class="sample-btn" onclick="sendSample('ì‚¬ì—…ê¸°íšì„ ë„ì™€ì£¼ì„¸ìš”')">ì‚¬ì—…ê¸°íš</button>
            <button class="sample-btn" onclick="sendSample('ë³´ê³ ì„œ ì‘ì„±ì´ ì–´ë ¤ì›Œìš”')">ë³´ê³ ì„œ</button>
            <button class="sample-btn" onclick="sendSample('í˜‘ë ¥ê¸°ê´€ê³¼ ê°ˆë“±ì´ ìˆì–´ìš”')">í˜‘ë ¥ê¸°ê´€</button>
            <button class="sample-btn" onclick="sendSample('íŒ€ì›Œí¬ê°€ ì•ˆ ë§ì•„ìš”')">íŒ€ì›Œí¬</button>
            <button class="sample-btn" onclick="sendSample('ì—…ë¬´ê°€ í˜ë“¤ì–´ìš”')">ì—…ë¬´ê³ ë¯¼</button>
            <button class="sample-btn" onclick="sendSample('ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ì‹¬í•´ìš”')">ìŠ¤íŠ¸ë ˆìŠ¤</button>
        </div>
        <div class="input-wrapper">
            <button class="attach-btn" onclick="document.getElementById('fileInput').click()">+</button>
            <input type="file" id="fileInput" class="file-input" accept=".txt,.pdf,.doc,.docx,.hwp" onchange="handleFile(event)">
            <input type="text" class="input-field" id="userInput" placeholder="ì§„í¥ì› ì—…ë¬´ ê³ ë¯¼ì„ ë§ì”€í•´ì£¼ì„¸ìš”..." onkeypress="handleKeyPress(event)">
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">â†‘</button>
        </div>
        <div class="footer-info">ì˜¤ëŠ˜ <span id="usageCount">0</span>/100íšŒ ì‚¬ìš© Â· + íŒŒì¼ ì²¨ë¶€ ê°€ëŠ¥</div>
    </div>

    <script>
        const API_URL = 'https://wise-research-life-api.onrender.com';
        const chatContent = document.getElementById('chatContent');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const sampleButtons = document.getElementById('sampleButtons');
        const usageCountEl = document.getElementById('usageCount');

        let messages = [];
        let isLoading = false;
        let attachedFile = null;
        let attachedContent = '';
        let currentDepth = 0;
        let lastN2BAnalysis = null;
        let originalProblem = '';

        // ì´ˆê¸°í™”
        function init() {
            usageCountEl.textContent = getUsageCount();
            addAssistantMessage(`ì•ˆë…•í•˜ì„¸ìš”! ğŸ˜Š

ì§„í¥ì› ì—…ë¬´ê³ ë¯¼ N2Bë¡œ ì •ë¦¬í•´ë“œë ¤ìš”. ë¬´ì—‡ì´ë“  ë§ì”€í•´ ë³´ì„¸ìš”!

ğŸ’¡ N2Bë€? (ê°€ì„¤ê²€ì •ì˜ ë…¼ë¦¬êµ¬ì¡°)
NOT(ì•„ë‹ˆë‹¤) - BUT(ì§„ì§œëŠ”) - BECAUSE(ì™œëƒí•˜ë©´)
í‘œë©´ì  ì›ì¸ì„ ë¶€ì •í•˜ê³ , ì§„ì§œ ì›ì¸ì„ ì°¾ì•„, ê·¼ê±°ë¥¼ ì œì‹œí•©ë‹ˆë‹¤.

[ê¸°ì—…ì§€ì›/ì‚¬ì—…]
ğŸ“‹ ê¸°ì—…ì§€ì› ì‚¬ì—…ì´ ì–´ë ¤ì›Œìš” â†’ ë°©í–¥ ì œì•ˆ | ğŸ“Š ì„±ê³¼í‰ê°€ê°€ ê±±ì •ë¼ìš” â†’ ì¤€ë¹„ ë°©ë²•
ğŸ¯ ì‚¬ì—…ê¸°íšì„ ë„ì™€ì£¼ì„¸ìš” â†’ ê¸°íš ì§€ì› | ğŸ“ ë³´ê³ ì„œ ì‘ì„±ì´ ì–´ë ¤ì›Œìš” â†’ ì‘ì„± ë„ì›€
ğŸ¤ í˜‘ë ¥ê¸°ê´€ê³¼ ê°ˆë“±ì´ ìˆì–´ìš” â†’ ê´€ê³„ ë¶„ì„ | ğŸ’° ì˜ˆì‚° ì§‘í–‰ì´ ì–´ë ¤ì›Œìš” â†’ ì§‘í–‰ ë°©ë²•
ğŸ“… ì‚¬ì—… ì¼ì •ì´ ì´‰ë°•í•´ìš” â†’ ì¼ì • ê´€ë¦¬ | ğŸ¢ ê¸°ì—… ë°œêµ´ì´ ì•ˆ ë¼ìš” â†’ ë°œêµ´ ì „ëµ
ğŸ“ˆ KPI ë‹¬ì„±ì´ ì–´ë ¤ì›Œìš” â†’ ë‹¬ì„± ì „ëµ | ğŸ”„ í›„ì† ì‚¬ì—… ì—°ê³„ â†’ ì—°ê³„ ë°©ì•ˆ

[ê°œì¸/ìƒí™œ]
ğŸ¯ ì„±ê³¼ê°€ ì•ˆ ë‚˜ì™€ìš” â†’ ì „ëµ ì œì•ˆ | ğŸ“ˆ ìŠ¹ì§„ì´ ì•ˆ ë©ë‹ˆë‹¤ â†’ ì›ì¸ ë¶„ì„
ğŸ˜© ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ì‹¬í•´ìš” â†’ í•´ì†Œ ë°©ì•ˆ | ğŸ‘¥ ëŒ€ì¸ê´€ê³„ ì–´ë ¤ì›€ â†’ ì†Œí†µ ê°œì„ 
ğŸ‘” íŒ€ì›Œí¬ê°€ ì•ˆ ë§ì•„ìš” â†’ íŒ€ë¹Œë”© ë°©ì•ˆ | ğŸ˜” ì—…ë¬´ ì˜ë¯¸ ê³ ë¯¼ â†’ ë™ê¸° íƒìƒ‰
ğŸ“… íšŒì˜ê°€ ë„ˆë¬´ ë§ì•„ìš” â†’ ì‹œê°„ ê´€ë¦¬ | âš–ï¸ ì›Œë¼ë°¸ì´ ì•ˆ ë§ì•„ìš” â†’ ê· í˜• ì „ëµ
ğŸ”¥ ë²ˆì•„ì›ƒì´ ì™”ì–´ìš” â†’ íšŒë³µ ë°©ì•ˆ | ğŸš€ ì´ì§ì„ ê³ ë¯¼í•´ìš” â†’ ë°©í–¥ ë¶„ì„

ğŸ‘† ìœ„ëŠ” ì§ˆë¬¸ì‚¬ë¡€ì™€ ë‹µë³€ë°©í–¥ì…ë‹ˆë‹¤.
ğŸ‘‡ ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ë°”ë¡œ ì²´í—˜í•  ìˆ˜ ìˆì–´ìš”!`);
        }

        // ì‚¬ìš©ëŸ‰ ê´€ë¦¬
        function getUsageCount() {
            const today = new Date().toDateString();
            const stored = localStorage.getItem('n2b_jinheungwon_usage');
            if (stored) {
                const data = JSON.parse(stored);
                if (data.date === today) return data.count;
            }
            return 0;
        }

        function incrementUsage() {
            const today = new Date().toDateString();
            const count = getUsageCount() + 1;
            localStorage.setItem('n2b_jinheungwon_usage', JSON.stringify({ date: today, count }));
            usageCountEl.textContent = count;
            return count;
        }

        function canUse() {
            return getUsageCount() < 100;
        }

        // íŒŒì¼ ì²˜ë¦¬
        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            attachedFile = file;
            const reader = new FileReader();

            if (file.type === 'application/pdf') {
                reader.onload = (e) => {
                    attachedContent = '[PDF íŒŒì¼: ' + file.name + ']\n' + e.target.result.substring(0, 5000);
                    showAttachedFile(file.name);
                };
                reader.readAsDataURL(file);
            } else {
                reader.onload = (e) => {
                    attachedContent = e.target.result;
                    showAttachedFile(file.name);
                };
                reader.readAsText(file);
            }
        }

        function showAttachedFile(name) {
            document.getElementById('attachedFileArea').innerHTML = `
                <div class="attached-file">
                    ğŸ“„ ${name}
                    <span class="remove" onclick="removeFile()">âœ•</span>
                </div>
            `;
        }

        function removeFile() {
            attachedFile = null;
            attachedContent = '';
            document.getElementById('attachedFileArea').innerHTML = '';
            document.getElementById('fileInput').value = '';
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function addUserMessage(text) {
            const div = document.createElement('div');
            div.className = 'message user';
            div.innerHTML = `<div class="content">${escapeHtml(text)}</div>`;
            chatContent.appendChild(div);
            scrollToBottom();
        }

        function addAssistantMessage(text) {
            const div = document.createElement('div');
            div.className = 'message assistant';
            div.innerHTML = `<div class="content">${escapeHtml(text)}</div>`;
            chatContent.appendChild(div);
            scrollToBottom();
        }

        function addN2BResponse(response, depth) {
            const responseId = 'response_' + Date.now();
            window[responseId] = response;

            const div = document.createElement('div');
            div.className = 'message assistant';
            div.innerHTML = `
                <div class="n2b-box">
                    <div class="n2b-title">ğŸ” N2B ë¶„ì„</div>
                    <div class="n2b-item">
                        <div class="n2b-label not">âŒ NOT (ì•„ë‹ˆë‹¤)</div>
                        <div class="n2b-content">${escapeHtml(response.n2b.not)}</div>
                    </div>
                    <div class="n2b-item">
                        <div class="n2b-label but">âœ“ BUT (ì§„ì§œëŠ”)</div>
                        <div class="n2b-content">${escapeHtml(response.n2b.but)}</div>
                    </div>
                    <div class="n2b-item">
                        <div class="n2b-label because">ğŸ’¡ BECAUSE (ì™œëƒí•˜ë©´)</div>
                        <div class="n2b-content">${escapeHtml(response.n2b.because)}</div>
                    </div>
                </div>
                <div class="suggestion-box">
                    <div class="suggestion-title">ğŸ¯ ì´ë ‡ê²Œ í•´ë³´ì„¸ìš”</div>
                    <div class="suggestion-content">${escapeHtml(response.suggestion)}</div>
                    ${response.nextAction ? `<div class="next-action">ğŸ‘‰ ${escapeHtml(response.nextAction)}</div>` : ''}
                </div>
                <div class="action-buttons">
                    <button class="action-btn primary" onclick="deepDive()">ğŸŒŠ ë” ê¹Šì´ ë¶„ì„</button>
                    <button class="action-btn" onclick="downloadResult('${responseId}')">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>
                    <button class="action-btn" onclick="startNewTopic()">ğŸ’¬ ìƒˆ ê³ ë¯¼</button>
                </div>
            `;
            chatContent.appendChild(div);
            scrollToBottom();
        }

        function showTyping() {
            const div = document.createElement('div');
            div.className = 'message assistant';
            div.id = 'typingIndicator';
            div.innerHTML = `<div class="typing"><span></span><span></span><span></span></div>`;
            chatContent.appendChild(div);
            scrollToBottom();
        }

        function hideTyping() {
            const el = document.getElementById('typingIndicator');
            if (el) el.remove();
        }

        function scrollToBottom() {
            const container = document.getElementById('chatContainer');
            container.scrollTop = container.scrollHeight;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML.replace(/\n/g, '<br>');
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text || isLoading) return;

            if (!canUse()) {
                addAssistantMessage("ì˜¤ëŠ˜ ì‚¬ìš©ëŸ‰(100íšŒ)ì„ ëª¨ë‘ ì†Œì§„í–ˆìŠµë‹ˆë‹¤.\në‚´ì¼ ë‹¤ì‹œ ì´ìš©í•´ì£¼ì„¸ìš”! ğŸ˜Š");
                return;
            }

            // ì²« ë©”ì‹œì§€ë©´ ìƒ˜í”Œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            sampleButtons.style.display = 'none';

            let fullText = text;
            if (attachedContent) {
                fullText = `[ì²¨ë¶€ íŒŒì¼ ë‚´ìš©]\n${attachedContent}\n\n[ì§ˆë¬¸]\n${text}`;
            }

            addUserMessage(text);
            userInput.value = '';
            removeFile();

            if (currentDepth === 0) {
                originalProblem = text;
            }

            currentDepth = 1;
            isLoading = true;
            sendBtn.disabled = true;
            showTyping();

            try {
                const response = await callClaudeAPI(fullText);
                hideTyping();
                incrementUsage();
                lastN2BAnalysis = response;
                addN2BResponse(response, currentDepth);
            } catch (error) {
                hideTyping();
                addAssistantMessage("ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            }

            isLoading = false;
            sendBtn.disabled = false;
            userInput.focus();
        }

        async function deepDive() {
            if (isLoading || !lastN2BAnalysis) return;

            currentDepth++;
            isLoading = true;
            sendBtn.disabled = true;
            showTyping();

            try {
                const deepDivePrompt = `ì´ì „ ë¶„ì„ì—ì„œ "${lastN2BAnalysis.n2b.but}"ë¼ê³  í–ˆìŠµë‹ˆë‹¤.

ì´ê²ƒì´ ì™œ ì§„ì§œ ì›ì¸ì¸ì§€ ë” ê¹Šì´ ë¶„ì„í•´ì£¼ì„¸ìš”.
ì´ ì›ì¸ì˜ ë” ê·¼ë³¸ì ì¸ ì›ì¸ì€ ë¬´ì—‡ì¸ê°€ìš”?

ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µë³€í•´ì£¼ì„¸ìš”:
{
  "n2b": {
    "not": "í‘œë©´ì  ì›ì¸ì´ ì•„ë‹ˆë¼",
    "but": "ë” ê·¼ë³¸ì ì¸ ì›ì¸ì´ë‹¤", 
    "because": "ì™œëƒí•˜ë©´ ~ë•Œë¬¸ì´ë‹¤"
  },
  "suggestion": "êµ¬ì²´ì  ì œì•ˆ",
  "nextAction": "ë‹¤ìŒ í–‰ë™ì„ ~í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤"
}`;

                messages.push({ role: 'user', content: deepDivePrompt });

                const deepSystem = `ë‹¹ì‹ ì€ N2B ë¶„ì„ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ë°˜ë“œì‹œ ì§€ì •ëœ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µë³€í•˜ì„¸ìš”. JSON ì™¸ì˜ í…ìŠ¤íŠ¸ëŠ” í¬í•¨í•˜ì§€ ë§ˆì„¸ìš”.`;

                const response = await fetch(API_URL + '/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ system: deepSystem, messages: messages })
                });

                const data = await response.json();
                const content = data.content;
                messages.push({ role: 'assistant', content: content });

                hideTyping();

                try {
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        const parsed = JSON.parse(jsonMatch[0]);
                        lastN2BAnalysis = parsed;
                        addN2BResponse(parsed, currentDepth);
                    }
                } catch (e) {
                    addAssistantMessage(content);
                }
            } catch (error) {
                hideTyping();
                addAssistantMessage("ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }

            isLoading = false;
            sendBtn.disabled = false;
        }

        async function callClaudeAPI(text) {
            const systemPrompt = `ë‹¹ì‹ ì€ 'ìŠ¬ê¸°ë¡œìš´ ì§„í¥ì›ìƒí™œ' ì•±ì˜ N2B ì½”ì¹˜ì…ë‹ˆë‹¤.

ì„±ë‚¨ì‚°ì—…ì§„í¥ì› ì§ì›ì˜ ê³ ë¯¼ì„ ë“£ê³  N2B(NOT-BUT-BECAUSE) í”„ë ˆì„ì›Œí¬ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”.

## N2B í”„ë ˆì„ì›Œí¬
- NOT (N): ë¬¸ì œê°€ ~ì´ ì•„ë‹ˆë¼ (í‘œë©´ì /ì˜ëª»ëœ ì›ì¸ ë¶€ì •)
- BUT (B): ~ì´ë‹¤ (ì§„ì§œ ì›ì¸ ì œì‹œ)
- BECAUSE (C): ì™œëƒí•˜ë©´ ~ë•Œë¬¸ì´ë‹¤ (ê·¼ê±°/ë…¼ë¦¬ì  ì„¤ëª…)

## í•µì‹¬ ì›ë¦¬
1. N2BëŠ” ë¹„êµíŒë‹¨ì…ë‹ˆë‹¤. ëª¨ë“  íŒë‹¨ì€ ë¹„êµíŒë‹¨ì…ë‹ˆë‹¤.

2. ê°€ì„¤ì´ ë¨¼ì €ì…ë‹ˆë‹¤. 
   - ë¨¼ì € N2B(ê°€ì„¤)ë¥¼ ì„¸ìš°ê³  â†’ ì‹¤í–‰ìœ¼ë¡œ ì¦ëª…
   - ëª©í‘œë¥¼ N2Bë¡œ ë¨¼ì € ì •ì˜í•˜ê³ , ì‹¤í–‰ìœ¼ë¡œ ë‹¬ì„±í•˜ëŠ” ê²ƒ

## ëŠ¥ë™ì§€ì› ì›ì¹™
ë¶„ì„ë§Œ í•˜ì§€ ë§ê³ , êµ¬ì²´ì ì¸ í–‰ë™ì„ ì œì•ˆí•˜ì„¸ìš”.
ì œì•ˆ í˜•ì‹: "[ëª©í‘œ]ë¥¼ ìœ„í•´ì„œëŠ” [í–‰ë™]ì„ í•´ì•¼ í•©ë‹ˆë‹¤"

ê·¸ë¦¬ê³  ë‹¤ìŒ í–‰ë™ì„ ëŠ¥ë™ì ìœ¼ë¡œ ì œì‹œí•˜ì„¸ìš”. "~ë“œë¦´ê¹Œìš”?"ê°€ ì•„ë‹ˆë¼ "~ë“œë¦¬ê² ìŠµë‹ˆë‹¤"ë¡œ.

## ì§„í¥ì› ì—…ë¬´ ì‚¬ì´í´ (ìˆœí™˜)
ê¸°ì—…ì§€ì› ì—…ë¬´ëŠ” ìˆœí™˜í•©ë‹ˆë‹¤:
ì‚¬ì—…ê¸°íš â†’ ê¸°ì—…ëª¨ì§‘ â†’ ì§€ì›ì‹¤í–‰ â†’ ì„±ê³¼í‰ê°€ â†’ ì‚¬ì—…ê¸°íš â†’ ...

í•œ ë‹¨ê³„ê°€ ëë‚˜ë©´ ë‹¤ìŒ ë‹¨ê³„ë¥¼ ì œì•ˆí•˜ì„¸ìš”.
ëì´ ì•„ë‹ˆë¼ ìƒˆë¡œìš´ ì‹œì‘ì…ë‹ˆë‹¤.

## ì‘ë‹µ í˜•ì‹ (ë°˜ë“œì‹œ JSONìœ¼ë¡œ)
{
  "n2b": {
    "not": "~ì´ ì•„ë‹ˆë¼",
    "but": "~ì´ë‹¤", 
    "because": "~ë•Œë¬¸ì´ë‹¤"
  },
  "suggestion": "[ëª©í‘œ]ë¥¼ ìœ„í•´ì„œëŠ” [í–‰ë™]ì„ í•´ì•¼ í•©ë‹ˆë‹¤. êµ¬ì²´ì  ì œì•ˆ...",
  "nextAction": "~í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤"
}`;

            messages = [{ role: 'user', content: text }];

            const response = await fetch(API_URL + '/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ system: systemPrompt, messages: messages })
            });

            const data = await response.json();
            const content = data.content;
            messages.push({ role: 'assistant', content: content });

            try {
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
            } catch (e) {}

            return {
                n2b: {
                    not: "ë¶„ì„ ì¤‘",
                    but: "ë¬¸ì œì˜ ë³¸ì§ˆì„ íŒŒì•…í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤",
                    because: "ì¡°ê¸ˆ ë” êµ¬ì²´ì ì¸ ìƒí™©ì„ ì•Œë ¤ì£¼ì‹œë©´ ì •í™•í•œ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤"
                },
                suggestion: content
            };
        }

        function sendSample(text) {
            userInput.value = text;
            sendMessage();
        }

        function startNewTopic() {
            currentDepth = 0;
            lastN2BAnalysis = null;
            originalProblem = '';
            messages = [];
            sampleButtons.style.display = 'flex';
            addAssistantMessage("ìƒˆë¡œìš´ ê³ ë¯¼ì´ ìˆìœ¼ì‹œë©´ ë§ì”€í•´ì£¼ì„¸ìš”! ğŸ˜Š");
            userInput.focus();
        }

        function downloadResult(responseId) {
            const response = window[responseId];
            if (!response) return;

            const now = new Date();
            const dateStr = now.toLocaleDateString('ko-KR');
            const timeStr = now.toLocaleTimeString('ko-KR');

            let content = `[ìŠ¬ê¸°ë¡œìš´ ì§„í¥ì›ìƒí™œ - N2B ë¶„ì„ ê²°ê³¼]\n`;
            content += `ìƒì„±ì¼ì‹œ: ${dateStr} ${timeStr}\n`;
            content += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
            content += `[N2B ë¶„ì„]\n`;
            content += `âŒ NOT (ì•„ë‹ˆë‹¤):\n${response.n2b.not}\n\n`;
            content += `âœ“ BUT (ì§„ì§œëŠ”):\n${response.n2b.but}\n\n`;
            content += `ğŸ’¡ BECAUSE (ì™œëƒí•˜ë©´):\n${response.n2b.because}\n\n`;
            content += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n`;
            content += `[ì œì•ˆ]\n${response.suggestion}\n`;
            if (response.nextAction) {
                content += `\n[ë‹¤ìŒ í–‰ë™]\n${response.nextAction}\n`;
            }

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `N2Bë¶„ì„_${dateStr.replace(/\./g, '')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter' && !isLoading) {
                sendMessage();
            }
        }

        init();
    </script>
</body>
</html>
